var COLOR_THEMES=[["rgba(237,20,91,.5)","rgba(255,245,155,.5)","rgba(131,203,157,.5)","rgba(1,170,199,.5)","rgba(0,173,241,.5)","rgba(0,144,187,.5)","rgba(144,39,142,.5)","rgba(135,129,191,.5)","rgba(50, 50, 122, 0.5)","rgba(243,155,195,.5)","rgba(237, 20, 91, 0.5)","rgba(189, 141, 193, 0.5)","rgba(144,39,142,.5)","rgba(255,245,155,.5)","rgba(191, 225, 201, 0.5)","rgba(238,0,140,.5)"],["rgba(255, 255, 255, 0.45)","rgba(248, 203, 224, 0.45)","rgba(243, 155, 195, 0.45)","rgba(238, 0, 140, 0.45)","rgba(254, 250, 203, 0.45)","rgba(251, 199, 178, 0.45)","rgba(245, 152, 160, 0.45)","rgba(236, 9, 114, 0.45)","rgba(184, 229, 250, 0.45)","rgba(187, 183, 220, 0.45)","rgba(189, 141, 193, 0.45)","rgba(190, 26, 141, 0.45)","rgba(191, 225, 201, 0.45)","rgba(192, 180, 180, 0.45)","rgba(192, 139, 157, 0.45)","rgba(190, 30, 116, 0.45)"],["rgba(109, 207, 246, 0.45)","rgba(126, 167, 219, 0.45)","rgba(135, 129, 191, 0.45)","rgba(144, 39, 142, 0.45)","rgba(123, 204, 198, 0.45)","rgba(134, 166, 177, 0.45)","rgba(141, 128, 158, 0.45)","rgba(150, 39, 118, 0.45)","rgba(0, 173, 241, 0.45)","rgba(0, 143, 213, 0.45)","rgba(0, 114, 187, 0.45)","rgba(46, 49, 146, 0.45)","rgba(1, 170, 199, 0.45)","rgba(2, 140, 176, 0.45)","rgba(0, 113, 157, 0.45)","rgba(50, 50, 122, 0.45)"],["rgba(255, 245, 155, 0.45)","rgba(253, 197, 138, 0.45)","rgba(243, 153, 119, 0.45)","rgba(237, 20, 91, 0.45)","rgba(254, 241, 2, 0.45)","rgba(254, 193, 14, 0.45)","rgba(247, 148, 29, 0.45)","rgba(238, 28, 37, 0.45)","rgba(194, 223, 156, 0.45)","rgba(194, 179, 140, 0.45)","rgba(194, 138, 123, 0.45)","rgba(190, 35, 93, 0.45)","rgba(202, 219, 43, 0.45)","rgba(201, 176, 47, 0.45)","rgba(199, 138, 49, 0.45)","rgba(193, 39, 47, 0.45)"],["rgba(30, 182, 206, 0.7)","rgba(235, 235, 235, 0.7)","rgba(215, 215, 215, 0.7)","rgba(183, 183, 183, 0.7)","rgba(149, 149, 149, 0.7)","rgba(125, 125, 125, 0.7)","rgba(99, 99, 99, 0.7)","rgba(70, 70, 70, 0.7)","rgba(237, 28, 37, 0.7)","rgba(240, 52, 35, 0.7)","rgba(242, 88, 33, 0.7)","rgba(245, 124, 31, 0.7)","rgba(244, 154, 193, 0.7)","rgba(238, 130, 155, 0.7)","rgba(229, 97, 100, 0.7)","rgba(223, 73, 62, 0.7)"]];(function(){var a,b,c,d,e;a=0,c=["ms","moz","webkit","o"];for(d=0,e=c.length;d<e;d++){b=c[d];if(!!window.requestAnimationFrame)continue;window.requestAnimationFrame=window[b+"RequestAnimationFrame"],window.cancelRequestAnimationFrame=window[b+"CancelRequestAnimationFrame"]}window.requestAnimationFrame||(window.requestAnimationFrame=function(b,c){var d,e,f;return e=(new Date).getTime(),d=Math.max(0,16-(e-f)),setTimeout(function(){return b(a+d)},d),f=e+d});if(!window.cancelAnimationFrame)return window.cancelAnimationFrame=function(a){return clearTimeout(a)}})();var Renderer,__bind=function(a,b){return function(){return a.apply(b,arguments)}};Renderer=function(){function a(){this.setSize=__bind(this.setSize,this),this.TO_RADIAN=Math.PI/180,this.TWO_PI=Math.PI*2,this.width=0,this.height=0,this.landscape=0,this.centerX=0,this.centerY=0,this.initialized=!1,this.renderTime=0,this.cnvs=document.createElement("canvas"),this.ctx=this.cnvs.getContext("2d"),this.mirror=document.createElement("canvas"),this.mctx=this.mirror.getContext("2d"),this.offscrn=document.createElement("canvas"),this.octx=this.offscrn.getContext("2d"),this.bleeding=!1,this.reflecting=!1}return a.prototype.init=function(a){return this.initialized=!0},a.prototype.render=function(a){var b,c,d,e,f,g,h,i,j,k,l;this.initialized||this.init(a),e=(new Date).getTime(),f=new Vector,b=new Vector,this.bleeding||(this.cnvs.width=this.cnvs.width),k=a.particles;for(g=0,i=k.length;g<i;g++)c=k[g],this.ctx.fillStyle=c.colour||"#FFFFFF",c.shape==="pentagon"?this.drawPentagon(c):c.shape==="square"?this.drawSquare(c):c.shape==="special"?this.drawCat(c):c.shape==="triangle"?this.drawTriangle(c):this.drawCircle(c);this.ctx.strokeStyle="rgba(249, 249, 222, 0.1)",this.ctx.beginPath(),l=a.springs;for(h=0,j=l.length;h<j;h++)d=l[h],this.ctx.moveTo(d.p1.pos.x,d.p1.pos.y),this.ctx.lineTo(d.p2.pos.x,d.p2.pos.y);return this.ctx.stroke(),this.ctx.fillStyle="rgba(255,255,255,0.2)",this.ctx.beginPath(),this.ctx.arc(this.mouse.pos.x,this.mouse.pos.y,20,0,this.TWO_PI),this.ctx.fill(),this.reflecting&&(this.octx.clearRect(0,0,this.width,this.height),this.mctx.fillStyle="#f9f9de",this.octx.save(),this.octx.beginPath(),this.octx.moveTo(0,0),this.octx.lineTo(this.centerX,this.centerY),this.octx.lineTo(0,this.centerY),this.octx.lineTo(0,0),this.octx.closePath(),this.octx.clip(),this.octx.drawImage(this.cnvs,0,0),this.octx.restore(),this.octx.save(),this.octx.globalCompositeOperation="destination-over",this.octx.translate(this.centerX,this.centerY),this.octx.scale(-1,1),this.octx.rotate(180*this.TO_RADIAN-Math.atan(this.centerY/this.centerX)*2),this.octx.drawImage(this.offscrn,-this.centerX,-this.centerY),this.octx.scale(-1,1),this.octx.drawImage(this.offscrn,this.centerX,-this.centerY),this.octx.restore(),this.landscape===90&&(this.octx.save(),this.octx.globalCompositeOperation="destination-over",this.octx.translate(this.centerX,this.centerY),this.octx.scale(-1,1),this.octx.rotate(135*this.TO_RADIAN-Math.atan(this.centerY/this.centerX)*2.4),this.octx.drawImage(this.offscrn,-this.centerX,-this.centerY),this.octx.scale(-1,1),this.octx.drawImage(this.offscrn,this.centerX,-this.centerY),this.octx.restore()),this.octx.clearRect(this.centerX,0,this.centerX,this.height),this.octx.clearRect(0,this.centerY,this.width,this.centerY),this.octx.save(),this.octx.translate(this.centerX,this.centerY),this.octx.scale(-1,-1),this.octx.drawImage(this.offscrn,-this.centerX,-this.centerY),this.octx.scale(-1,1),this.octx.drawImage(this.offscrn,-this.centerX,-this.centerY),this.octx.restore(),this.mctx.fillRect(0,0,this.width,this.height),this.mctx.drawImage(this.offscrn,0,0)),this.renderTime=(new Date).getTime()-e},a.prototype.drawCat=function(a){return this.ctx.beginPath(),this.ctx.moveTo(a.pos.x-a.radius,a.pos.y),this.ctx.lineTo(a.pos.x-a.radius,a.pos.y-a.radius*1.5),this.ctx.lineTo(a.pos.x,a.pos.y),this.ctx.arc(a.pos.x,a.pos.y,a.radius,0,this.TWO_PI,!1),this.ctx.moveTo(a.pos.x+a.radius,a.pos.y),this.ctx.lineTo(a.pos.x+a.radius,a.pos.y-a.radius*1.5),this.ctx.lineTo(a.pos.x,a.pos.y),this.ctx.arc(a.pos.x,a.pos.y,a.radius,0,this.TWO_PI,!1),this.ctx.closePath(),this.ctx.fill()},a.prototype.drawCircle=function(a){return this.ctx.beginPath(),this.ctx.arc(a.pos.x,a.pos.y,a.radius,0,this.TWO_PI,!1),this.ctx.closePath(),this.ctx.fill()},a.prototype.drawPentagon=function(a){return this.ctx.beginPath(),this.ctx.moveTo(a.pos.x,a.pos.y-a.radius),this.ctx.lineTo(a.pos.x-a.radius,a.pos.y),this.ctx.lineTo(a.pos.x+ -a.radius*.5,a.pos.y+a.radius*(Math.sqrt(3)/2)),this.ctx.lineTo(a.pos.x+a.radius*.5,a.pos.y+a.radius*(Math.sqrt(3)/2)),this.ctx.lineTo(a.pos.x+a.radius,a.pos.y),this.ctx.lineTo(a.pos.x,a.pos.y-a.radius),this.ctx.closePath(),this.ctx.fill()},a.prototype.drawSquare=function(a){return this.ctx.beginPath(),this.ctx.fillRect(a.pos.x-a.radius,a.pos.y-a.radius,a.radius*2,a.radius*2),this.ctx.closePath(),this.ctx.fill()},a.prototype.drawTriangle=function(a){var b;return b=~~(a.radius*(6/Math.sqrt(3))),this.ctx.beginPath(),this.ctx.moveTo(a.pos.x,a.pos.y-a.radius),this.ctx.lineTo(a.pos.x-b/5,a.pos.y+b/5),this.ctx.lineTo(a.pos.x+b/5,a.pos.y+b/5),this.ctx.closePath(),this.ctx.fill()},a.prototype.reset=function(){return this.cnvs.width=this.cnvs.width,this.mirror.width=this.mirror.width,this.offscrn.width=this.offscrn.width,this.initialized=!1},a.prototype.setSize=function(a,b){return this.landscape=a>b?90:0,this.width=a,this.height=b,this.centerX=this.width/2,this.centerY=this.height/2,this.cnvs.width=this.width,this.cnvs.height=this.height,this.mirror.width=this.width,this.mirror.height=this.height,this.offscrn.width=this.width,this.offscrn.height=this.height},a}();var World,__bind=function(a,b){return function(){return a.apply(b,arguments)}};World=function(){function a(){this.resize=__bind(this.resize,this),this.mousemove=__bind(this.mousemove,this),this.COLORS=COLOR_THEMES[0],this.THEMES=COLOR_THEMES,this.width=window.innerWidth,this.height=window.innerHeight}return a.prototype.init=function(a,b){var c;return this.container=a,this.renderer=b,this.setup(),c=typeof Modernizr!="undefined"&&Modernizr!==null&&Modernizr.touch?"touchmove":"mouseup",this.container.addEventListener(c,this.mousemove,!1),document.addEventListener("resize",this.resize,!1),window.addEventListener("resize",this.resize,!1),window.addEventListener("orientationchange",this.resize,!1),this.container.appendChild(this.renderer.cnvs),this.container.appendChild(this.renderer.mirror),this.resize()},a.prototype.setup=function(){var a;return a=Math.max(this.width,this.height),this.renderTime=0,this.counter=0,this.physics=new Physics,this.mouse=new Particle,this.mouse.fixed=!0,this.mouse.pos.set(this.width/2,this.height/2),this.physics.particles.push(this.mouse),this.max=400,this.physics.integrator=new ImprovedEuler,this.center=new Attraction(this.mouse.pos,500,1200),this.edge=new EdgeWrap(new Vector(0,0),new Vector(a,a)),this.renderer.mouse=this.mouse,this.renderer.init(this.physics)},a.prototype.addShape=function(a){var b,c,d,e,f,g;c=~~Random(3,10),f=this.physics.particles.length,f+c>this.max&&(this.physics.particles.splice(1,f+c-this.max),this.physics.springs.splice(1,f+c-this.max));for(b=g=c;c<=0?g<=0:g>=0;b=c<=0?++g:--g)d=new Particle(Random(.1,4)),d.setRadius(~~(d.mass*15)),d.behaviours.push(new Wander(.5,700,Random(1,2))),d.behaviours.push(this.center),d.behaviours.push(this.edge),d.moveTo(new Vector(~~Random(this.width),~~Random(this.height))),d.colour=this.COLORS[(f+c-b)%this.COLORS.length],d.shape=a,e=new Spring(this.mouse,d,Random(30,300),Random(0,1)),this.physics.particles.push(d),this.physics.springs.push(e);return this.renderWorld()},a.prototype.mousemove=function(a){var b;return a.preventDefault(),a.touches&&!!a.touches.length?(b=a.touches[0],this.mouse.pos.set(b.pageX,b.pageY)):this.mouse.pos.set(a.clientX,a.clientY)},a.prototype.resize=function(a){var b,c;return this.width=window.innerWidth,this.height=window.innerHeight,a!=null&&($("body").height(window.innerHeight+100+"px"),window.scrollTo(0,1),$("body").height(window.innerHeight+"px")),this.landscape=this.width>this.height?90:0,this.container.style.width=this.width+"px",this.container.style.height=this.height+"px",this.mouse.pos.set(this.width/2,this.height/2),this.renderer.setSize(this.width,this.height),this.renderWorld(),b=this.THEMES.length,c=this.width/(b*4),$("#color-themes li span").height(c+"px")},a.prototype.renderWorld=function(){return this.renderer.render(this.physics)},a.prototype.setTheme=function(a){var b,c,d,e,f;a!=null&&(a=parseInt(a,10),this.COLORS=this.THEMES[a]),f=this.physics.particles;for(b=d=0,e=f.length;d<e;b=++d)c=f[b],c.colour=this.COLORS[(e-b)%this.COLORS.length];return this.renderWorld()},a.prototype.step=function(){this.physics.step();if(++this.counter%3===0)return this.renderWorld()},a}();var Controls,k_interface,k_world,__bind=function(a,b){return function(){return a.apply(b,arguments)}};Controls=function(){function a(){this.update=__bind(this.update,this),this.toggleThemes=__bind(this.toggleThemes,this),this.togglePixelate=__bind(this.togglePixelate,this),this.togglePause=__bind(this.togglePause,this),this.toggleMirrors=__bind(this.toggleMirrors,this),this.toggleMenu=__bind(this.toggleMenu,this),this.toggleEdit=__bind(this.toggleEdit,this),this.toggleBleed=__bind(this.toggleBleed,this),this.step=__bind(this.step,this),this.selectTheme=__bind(this.selectTheme,this),this.resetAll=__bind(this.resetAll,this),this.exportAll=__bind(this.exportAll,this),this.addShape=__bind(this.addShape,this),this.playing=!1}return a.prototype.init=function(a){var b,c;this.world=a,this.playing=!0,this.pixelate=!1,this.pixelImgId="pixel-img",this.update(),this.themes=$("#color-themes").hide(),this.items={},this.actions={kaleidoscope:this.toggleMirrors,pixelate:this.togglePixelate,bleed:this.toggleBleed,colors:this.toggleThemes,edit:this.toggleEdit,hide:this.toggleMenu,animate:this.togglePause,reset:this.resetAll,"screenshot a":this.exportAll},Modernizr.touch?this.startEvent="touchmove touchend":this.startEvent="mousedown";for(b in this.actions)c=$("#"+b),c.bind(this.startEvent,this.actions[b]),c.data("action",b),this.items[b]=c;this.setupColors(),this.toggleEdit(),$("li.shape").bind(this.startEvent,this.addShape),$(this.world.container).bind(this.startEvent,this.step);if(!Modernizr.localstorage)return this.items["screenshot a"].remove()},a.prototype.addShape=function(a){return a!=null&&a.stopPropagation(),this.world.addShape($(a.target).parent().attr("id"))},a.prototype.exportAll=function(a){var b;return a.stopPropagation(),a.preventDefault(),this.pixelate?b=$("#"+this.pixelImgId)[0].toDataURL("jpg/image"):this.world.renderer.reflecting?b=this.world.renderer.mirror.toDataURL("jpg/image"):b=this.world.renderer.cnvs.toDataURL("jpg/image"),localStorage.setItem("kaleidoscope_screenshot",b)},a.prototype.pause=function(a){return this.items.animate.removeClass("playing").addClass("paused"),this.playing=!1},a.prototype.play=function(){this.items.animate.removeClass("paused").addClass("playing"),this.items.edit.removeClass("open"),this.items.reset.hide,this.playing=!0;if(this.pixelate)return this.togglePixelate()},a.prototype.removeSpring=function(a){var b,c;if(a%500===0){b=~~Random(1,this.world.physics.springs.length-1),c=this.world.physics.springs[b];if(c!=null)return c.p2.behaviours.push(new Attraction(c.p1.pos,500,-2e3)),this.world.physics.springs.splice(b,1)}},a.prototype.resetAll=function(a){a!=null&&(a.stopPropagation(),a.preventDefault());if(confirm("Clear all of the things? You sure?"))return this.pixelate=!1,this.items.pixelate.removeClass("active"),this.pause(),this.items.edit.addClass("open"),this.world.physics.destroy(),this.world.physics=null,this.world.renderer.reset(),this.world.setup(),localStorage.setItem("kaleidoscope_screenshot",""),$("#"+this.pixelImgId).remove(),$(this.world.renderer.cnvs).show(),$(this.world.renderer.mirror).show()},a.prototype.selectTheme=function(a){return a!=null&&a.stopPropagation(),this.world.setTheme($(a.target).parent().attr("id")),this.toggleThemes()},a.prototype.setupColors=function(){var a,b,c,d,e,f,g,h,i,j,k,l;d=this.world.THEMES.length,f=this.world.width/(d*4),k=this.world.THEMES,l=[];for(b=g=0,i=k.length;g<i;b=++g){e=k[b],c=$("<li>").attr("id",b+"_theme"),c.append($("<h2>").text(b));for(h=0,j=e.length;h<j;h++)a=e[h],c.append($('<span style="background-color:'+a+"; height:"+f+'px">'));this.themes.append(c),l.push(c.bind(this.startEvent,this.selectTheme))}return l},a.prototype.step=function(a){if(!this.playing)return this.world.step(),this.world.renderer.render(this.world.physics)},a.prototype.toggleBleed=function(a){a!=null&&a.stopPropagation(),this.world.renderer.bleeding=!this.world.renderer.bleeding,this.items.bleed.toggleClass("active");if(!this.playing)return this.world.renderer.render(this.world.physics)},a.prototype.toggleEdit=function(a){return a!=null&&a.stopPropagation(),this.items.edit.toggleClass("open"),this.items.edit.hasClass("open")?(this.pause(),this.items.reset.show()):(this.play(),this.items.colors.removeClass("active"),this.themes.hide(),this.items.reset.hide())},a.prototype.toggleMenu=function(a){a!=null&&a.stopPropagation(),this.items.hide.toggleClass("flip").siblings().toggle().parent().toggleClass("collapsed"),this.items.animate.toggleClass("minimized");if(this.items.hide.hasClass("flip"))return this.items.reset.hide();if(this.items.edit.hasClass("open"))return this.items.reset.show()},a.prototype.toggleMirrors=function(a){a!=null&&a.stopPropagation();if(!this.pixelate){this.items.kaleidoscope.toggleClass("active"),this.world.renderer.reflecting=!this.world.renderer.reflecting;if(!this.world.renderer.reflecting)return $(this.world.renderer.cnvs).show(),$(this.world.renderer.mirror).hide(),this.world.renderer.mctx.clearRect(0,0,this.world.width,this.world.height);$(this.world.renderer.cnvs).hide(),$(this.world.renderer.mirror).show();if(!this.playing)return this.world.renderer.render(this.world.physics)}},a.prototype.togglePause=function(a){return this.playing?this.pause():this.play()},a.prototype.togglePixelate=function(a){return a!=null&&a.stopPropagation(),this.items.pixelate.toggleClass("active"),this.pixelate=!this.pixelate,this.pixelate?this.updatePixelate():($(this.world.renderer.cnvs).fadeIn(0),$(this.world.renderer.mirror).fadeIn(0),$("#"+this.pixelImgId).remove())},a.prototype.toggleThemes=function(a){return a!=null&&a.stopPropagation(),this.items.colors.toggleClass("active"),this.themes.slideToggle("fast")},a.prototype.update=function(a){requestAnimationFrame(this.update);if(this.playing&&this.world)return this.world.step(),this.removeSpring(a)},a.prototype.updatePixelate=function(){var a,b,c=this;return this.world.renderer.reflecting?a=this.world.renderer.mirror.toDataURL("png/image"):a=this.world.renderer.cnvs.toDataURL("png/image"),b=document.createElement("img"),b.src=a,b.id=this.pixelImgId,b.style.opacity=0,b.addEventListener("load",function(){return b.closePixelate([{shape:"square",resolution:18,size:20,offset:0,alpha:.271},{shape:"diamond",resolution:18,size:38,offset:0,alpha:.651}]),$("#"+c.pixelImgId).css("opacity",1),$(c.world.renderer.cnvs).fadeOut(0),$(c.world.renderer.mirror).fadeOut(0)},!1),this.world.container.appendChild(b)},a}(),$("body").height(window.innerHeight+100+"px"),window.scrollTo(0,1),$("body").height(window.innerHeight+"px"),k_world=new World,k_world.init(document.getElementById("viewport"),new Renderer),k_interface=new Controls,k_interface.init(k_world),k_interface.world.addShape("circle");